<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿ç“¦éš†éŠæˆ²åŠ©æ‰‹ (å°ˆæ¥­ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --accent-color: #ff4757;
            --secondary-color: #2ed573;
            --card-bg: #2d3436;
            --border-color: #444;
            --danger-color: #ff6b6b;
        }

        body {
            font-family: -apple-system, "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        h1 { color: var(--accent-color); margin: 10px 0; font-size: 1.8rem; }
        
        .container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’ç ´å¯¬åº¦ */
        }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; display: flex; justify-content: space-between; align-items: center;}
        
        /* è¼¸å…¥å€å¡Š */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: #111;
            color: white;
            font-size: 1rem;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .btn-primary { background-color: var(--accent-color); color: white; width: 100%; }
        .btn-add { background-color: var(--secondary-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        
        .btn-outline-danger {
            background: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .btn-outline-danger:hover { background: var(--danger-color); color: white; }

        .btn-small { padding: 8px 15px; font-size: 0.9rem; background: #555; color: white; width: 100%; }

        button:disabled { background-color: #555; opacity: 0.7; cursor: not-allowed; }

        /* ç©å®¶åå–® */
        .player-list-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .player-tag {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* è§’è‰²é…ç½® */
        .roles-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            text-align: left;
            margin-bottom: 20px;
        }

        .role-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }
        
        .role-item input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--accent-color); }

        /* ä»»å‹™å‹¾é¸å€ */
        .mission-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .mission-checkbox {
            display: block;
            background: #333;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
            text-align: center;
        }

        .mission-checkbox input { display: none; } /* éš±è—åŸç”Ÿ checkbox */
        .mission-checkbox:has(input:checked) { 
            background: var(--secondary-color); 
            color: #000; 
            font-weight: bold; 
            box-shadow: 0 0 10px rgba(46, 213, 115, 0.4);
        }

        /* æ­·å²è¡¨æ ¼ */
        .history-log {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .history-log th, .history-log td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }

        .history-log th { background: #333; }

        #narratorText { color: var(--secondary-color); font-size: 1.2rem; margin: 20px 0; min-height: 1.5em; text-align: center;}
        
        .round-badge {
            background: var(--accent-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 4px;
            display: inline-block;
            margin-bottom: 2px;
        }
        
        .player-count-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 20px;
            align-items: center;
        }
    </style>
</head>
<body>

    <h1>é˜¿ç“¦éš†éŠæˆ²åŠ©æ‰‹</h1>

    <!-- SECTION 1: è¨­ç½®èˆ‡ç©å®¶è¼¸å…¥ -->
    <div id="section-setup" class="container section active">
        <h3>
            1. ç©å®¶åå–®
            <!-- æ–°å¢ï¼šæ¸…ç©ºæŒ‰éˆ• -->
            <button class="btn-outline-danger" onclick="clearAllPlayers()">æ¸…ç©ºåå–®</button>
        </h3>
        
        <div class="input-group">
            <input type="text" id="newPlayerName" placeholder="è¼¸å…¥ç©å®¶åå­— (Enter)" onkeypress="handleEnter(event)">
            <button class="btn-add" onclick="addPlayer()">åŠ å…¥</button>
        </div>
        
        <div id="playerListDisplay" class="player-list-grid">
            <!-- ç©å®¶åˆ—è¡¨ -->
        </div>
        
        <div class="player-count-info">
            <span>ç•¶å‰äººæ•¸: <span id="playerCount">0</span> äºº</span>
            <span>(å»ºè­° 5-10 äºº)</span>
        </div>

        <h3>2. è§’è‰²é…ç½®</h3>
        <div class="roles-grid">
            <label class="role-item"><input type="checkbox" id="merlin" checked> æ¢…æ—</label>
            <label class="role-item"><input type="checkbox" id="percival" checked> æ´¾è¥¿ç¶­çˆ¾</label>
            <label class="role-item"><input type="checkbox" id="assassin" checked> åˆºå®¢</label>
            <label class="role-item"><input type="checkbox" id="morgana"> è«ç”˜å¨œ</label>
            <label class="role-item"><input type="checkbox" id="mordred"> è«å¾·é›·å¾·</label>
            <label class="role-item"><input type="checkbox" id="oberon"> å¥§ä¼¯å€«</label>
        </div>

        <button class="btn-primary" onclick="startNightPhase()">ç¢ºèªè¨­å®šä¸¦é–‹å§‹å¤©é»‘</button>
        <p id="voiceStatus" style="font-size: 0.8rem; color: #666; margin-top: 10px;">èªéŸ³è¼‰å…¥ä¸­...</p>
    </div>

    <!-- SECTION 2: å¤œé–“èªéŸ³ -->
    <div id="section-night" class="container section">
        <h3>å¤œé–“èªéŸ³é€²è¡Œä¸­</h3>
        <div style="text-align: center; padding: 30px 0;">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸŒ‘</div>
            <div id="narratorText">æº–å‚™é–‹å§‹...</div>
        </div>
        <button class="btn-danger" onclick="skipNarrator()">è·³éèªéŸ³ (ç›´æ¥å¤©äº®)</button>
    </div>

    <!-- SECTION 3: éŠæˆ²è¨˜éŒ„æ¿ -->
    <div id="section-game" class="container section">
        <h3>ç¬¬ <span id="currentRoundDisplay">1</span> å±€ - ä»»å‹™è¨˜éŒ„</h3>
        <p style="color:#aaa; font-size:0.9rem; margin-bottom: 10px;">è«‹é»é¸æœ¬å±€å‡ºä»»å‹™çš„ç©å®¶ï¼š</p>
        
        <div id="missionSelectionArea" class="mission-selector">
            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <button class="btn-primary" id="recordBtn" onclick="recordMissionResult()">è¨˜éŒ„æœ¬å±€ä»»å‹™</button>
        
        <h3 style="margin-top: 30px;">æ­·å²ç´€éŒ„</h3>
        <table class="history-log">
            <thead>
                <tr>
                    <th style="width: 40px;">å±€æ•¸</th>
                    <th>å‡ºä»»å‹™ç©å®¶</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
            </tbody>
        </table>

        <div style="margin-top: 30px; border-top: 1px solid #444; padding-top: 20px;">
            <!-- ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„é‡ç½®å‡½æ•¸ï¼Œè€Œéåˆ·æ–°é é¢ -->
            <button class="btn-small" onclick="resetGameToSetup()">çµæŸæœ¬å±€ / å›åˆ°è¨­ç½®é </button>
            <p style="color: #666; font-size: 0.8rem; margin-top: 5px;">(ç©å®¶åå–®å°‡æœƒä¿ç•™)</p>
        </div>
    </div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let players = [];
    let currentRound = 1;
    let missionHistory = [];
    
    // èªéŸ³è¨­å®š
    const synth = window.speechSynthesis;
    let selectedVoice = null;

    // --- åˆå§‹åŒ– ---
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    function loadVoices() {
        const voices = synth.getVoices();
        selectedVoice = voices.find(v => v.lang === 'zh-HK') || 
                        voices.find(v => v.lang === 'zh-TW') || 
                        voices.find(v => v.lang.includes('zh'));
        if(selectedVoice) document.getElementById('voiceStatus').innerText = `èªéŸ³å°±ç·’: ${selectedVoice.name}`;
    }

    // --- ç©å®¶åå–®åŠŸèƒ½ (æ–°å¢æ¸…ç©ºåŠŸèƒ½) ---
    function handleEnter(e) {
        if (e.key === 'Enter') addPlayer();
    }

    function addPlayer() {
        const input = document.getElementById('newPlayerName');
        const name = input.value.trim();
        if (name && !players.includes(name)) {
            players.push(name);
            renderPlayers();
            input.value = '';
        } else if (players.includes(name)) {
            alert("åå­—é‡è¤‡äº†ï¼");
        }
        input.focus();
    }

    function removePlayer(index) {
        players.splice(index, 1);
        renderPlayers();
    }

    // æ–°å¢ï¼šæ¸…ç©ºå…¨éƒ¨ç©å®¶
    function clearAllPlayers() {
        if (players.length === 0) return;
        if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç©å®¶åå–®å—ï¼Ÿ")) {
            players = [];
            renderPlayers();
        }
    }

    function renderPlayers() {
        const container = document.getElementById('playerListDisplay');
        container.innerHTML = '';
        players.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'player-tag';
            div.innerHTML = `<span>${p}</span><span style="cursor:pointer; margin-left:8px;" onclick="removePlayer(${index})">âœ•</span>`;
            container.appendChild(div);
        });
        document.getElementById('playerCount').innerText = players.length;
    }

    // --- é é¢åˆ‡æ› ---
    function switchSection(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0, 0); // åˆ‡æ›é é¢æ™‚æ»¾å‹•åˆ°é ‚éƒ¨
    }

    // --- æ–°å¢ï¼šå›åˆ°è¨­ç½®é  (ä¿ç•™åå–®) ---
    function resetGameToSetup() {
        if (!confirm("ç¢ºå®šè¦çµæŸé€™å±€éŠæˆ²ä¸¦å›åˆ°è¨­ç½®é ï¼Ÿ\n(ç©å®¶åå–®æœƒä¿ç•™ï¼Œä½†æ­·å²ç´€éŒ„å°‡æ¸…ç©º)")) return;

        // é‡ç½®éŠæˆ²è®Šæ•¸
        currentRound = 1;
        missionHistory = [];

        // æ¸…ç©ºä»‹é¢é¡¯ç¤º
        document.getElementById('historyTableBody').innerHTML = '';
        document.getElementById('currentRoundDisplay').innerText = '1';
        document.getElementById('narratorText').innerText = 'æº–å‚™é–‹å§‹...';

        // å›åˆ°é¦–é 
        switchSection('section-setup');
    }

    // --- èªéŸ³æµç¨‹ ---
    const wait = (ms) => new Promise(r => setTimeout(r, ms));
    const speak = (text) => {
        return new Promise((resolve) => {
            document.getElementById('narratorText').innerText = text;
            const u = new SpeechSynthesisUtterance(text);
            if (selectedVoice) u.voice = selectedVoice;
            u.rate = 0.95;
            u.onend = resolve;
            synth.speak(u);
        });
    };

    async function startNightPhase() {
        if (players.length < 5 && players.length > 0) {
            if (!confirm("ç›®å‰ç©å®¶å°‘æ–¼5äººï¼Œç¢ºå®šè¦é–‹å§‹å—ï¼Ÿ")) return;
        }
        
        switchSection('section-night');
        
        // è§’è‰²é‚è¼¯
        const config = {
            merlin: document.getElementById('merlin').checked,
            percival: document.getElementById('percival').checked,
            mordred: document.getElementById('mordred').checked,
            oberon: document.getElementById('oberon').checked,
            morgana: document.getElementById('morgana').checked
        };

        try {
            await speak("å¤©é»‘è«‹é–‰çœ¼ï¼Œæ‰€æœ‰äººæ‰‹æ¡æ‹³é ­æ“ºå–ºæ±é¢ã€‚");
            await wait(1500);

            // å£äºº
            let minionText = "å£äººè«‹èˆ‰æ‰‹ï¼Œå¼µé–‹çœ¼ï¼Œäº’ç›¸ç¢ºèªèº«ä»½ã€‚";
            if (config.oberon) minionText += " å¥§ä¼¯å€«è«‹å””å¥½å¼µé–‹çœ¼ã€‚";
            await speak(minionText);
            await wait(4000);
            await speak("å£äººè«‹é–‰çœ¼ï¼Œæ‰‹æ”¾ä½ã€‚");
            await wait(1500);

            // æ¢…æ—
            if (config.merlin) {
                let merlinText = "æ¢…æ—è«‹å¼µé–‹çœ¼ã€‚å£äººè«‹èˆ‰èµ·æ‰‹æŒ‡å…¬ã€‚";
                if (config.mordred) merlinText += " è«å¾·é›·å¾·è«‹å””å¥½èˆ‰æ‰‹ã€‚";
                await speak(merlinText);
                await wait(3500);
                await speak("æ¢…æ—è«‹é–‰çœ¼ï¼Œå£äººæ‰‹æ”¾ä½ã€‚");
                await wait(1500);
            }

            // æ´¾è¥¿ç¶­çˆ¾
            if (config.percival) {
                let percyText = "æ´¾è¥¿ç¶­çˆ¾è«‹å¼µé–‹çœ¼ã€‚";
                percyText += config.morgana ? " æ¢…æ—åŒè«ç”˜å¨œè«‹èˆ‰èµ·æ‰‹æŒ‡å…¬ã€‚" : " æ¢…æ—è«‹èˆ‰èµ·æ‰‹æŒ‡å…¬ã€‚";
                await speak(percyText);
                await wait(3500);
                await speak("æ´¾è¥¿ç¶­çˆ¾è«‹é–‰çœ¼ï¼Œå…¶ä»–äººæ‰‹æ”¾ä½ã€‚");
                await wait(1500);
            }

            await speak("å¤©å…‰ï¼æ‰€æœ‰äººè«‹å¼µé–‹çœ¼ã€‚éŠæˆ²é–‹å§‹ï¼");
            startGameLoop(); 

        } catch (e) { console.error(e); }
    }

    function skipNarrator() {
        synth.cancel();
        startGameLoop();
    }

    // --- éŠæˆ²è¨˜éŒ„ ---
    function startGameLoop() {
        switchSection('section-game');
        renderMissionCheckboxes();
    }

    function renderMissionCheckboxes() {
        const container = document.getElementById('missionSelectionArea');
        container.innerHTML = '';
        
        // å¦‚æœæ²’åå­—ï¼Œå°±ç”¨é è¨­ä»£è™Ÿ
        const listToRender = players.length > 0 ? players : ['P1','P2','P3','P4','P5'];

        listToRender.forEach((p) => {
            const label = document.createElement('label');
            label.className = 'mission-checkbox';
            label.innerHTML = `<input type="checkbox" value="${p}" name="missionPlayer"> ${p}`;
            container.appendChild(label);
        });
        document.getElementById('currentRoundDisplay').innerText = currentRound;
    }

    function recordMissionResult() {
        const checkboxes = document.querySelectorAll('input[name="missionPlayer"]:checked');
        if (checkboxes.length === 0) {
            alert("è«‹è‡³å°‘å‹¾é¸ä¸€ä½ç©å®¶ï¼");
            return;
        }

        const selectedNames = Array.from(checkboxes).map(cb => cb.value);
        missionHistory.push({ round: currentRound, team: selectedNames });
        
        // æ›´æ–°è¡¨æ ¼
        const tbody = document.getElementById('historyTableBody');
        const row = document.createElement('tr');
        const teamHtml = selectedNames.map(n => `<span class="round-badge">${n}</span>`).join('');
        row.innerHTML = `<td style="text-align:center; font-weight:bold;">${currentRound}</td><td>${teamHtml}</td>`;
        tbody.prepend(row); // æ–°çš„æ”¾ä¸Šé¢

        // ä¸‹ä¸€å±€
        currentRound++;
        document.getElementById('currentRoundDisplay').innerText = currentRound;
        checkboxes.forEach(cb => cb.checked = false);
        
        // æŒ‰éˆ•å›é¥‹
        const btn = document.getElementById('recordBtn');
        const orgText = btn.innerText;
        btn.innerText = "å·²è¨˜éŒ„ï¼";
        btn.style.background = "#2ed573";
        setTimeout(() => {
            btn.innerText = orgText;
            btn.style.background = "";
        }, 800);
    }
</script>

</body>
</html>